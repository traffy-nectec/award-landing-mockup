<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fondue Award - Excellence in Action</title>
    
    <!-- Font: IBM Plex Sans Thai -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet CSS for OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['IBM Plex Sans Thai', 'sans-serif'],
                    },
                    colors: {
                        fondue: '#553924',
                        'fondue-accent': '#8c6b5d',
                        'dark-bg': '#050505',
                        'dark-surface': '#1c1c1e',
                        'dark-surface-lighter': '#2c2c2e',
                        'text-primary': '#f5f5f7',
                        'text-secondary': '#a1a1a6',
                        accent: '#60a5fa', 
                        success: '#34C759',
                        pending: '#FF9F0A',
                        partial: '#334155', 
                        'h-0': '#262626',
                        'h-1': '#4a3728',
                        'h-2': '#78350f',
                        'h-3': '#991b1b',
                        'h-4': '#7f1d1d',
                    },
                    borderRadius: {
                        '3xl': '1.5rem',
                        '4xl': '2rem',
                    },
                }
            }
        }
    </script>
    
    <style>
        body {
            background-color: #050505;
            color: #f5f5f7;
            scroll-behavior: smooth;
        }

        .glass-nav {
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .reveal {
            opacity: 1;
            transform: translateY(0);
        }

        .bento-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .bento-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6);
            border-color: rgba(255,255,255,0.2);
        }

        /* --- MAP STYLES --- */
        .map-wrapper {
            position: relative;
            width: 100%;
            height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, rgba(96, 165, 250, 0.05) 0%, rgba(0,0,0,0) 70%);
        }
        #thailand-svg { width: 100%; height: 100%; max-width: 400px; overflow: visible; }
        
        .map-group { fill: #334155; }
        .province { cursor: pointer; transition: fill 0.3s ease; }
        .province circle { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); r: 0.4; }
        .province:hover circle, .province.highlight-group circle {
            fill: #60a5fa; filter: drop-shadow(0 0 1px rgba(96, 165, 250, 0.8));
            transform: scale(1.3); transform-origin: center; transform-box: fill-box;
        }
        .province.completed { fill: #34C759; }
        .province.pending { fill: #FF9F0A; }
        .animating-flip circle { animation: dotPop 0.3s ease-in-out; transform-origin: center; transform-box: fill-box; }

        @keyframes dotPop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.2); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- OSM LEAFLET MAP STYLES (DARK MODE) --- */
        .leaflet-container {
            background: transparent !important;
        }
        .leaflet-layer {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        /* --- HEATMAP STYLES --- */
        .calendar-month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day-header {
            text-align: center;
            font-size: 10px;
            color: #a1a1a6;
            margin-bottom: 4px;
        }
        .calendar-day {
            aspect-ratio: 1;
            border-radius: 4px;
            background-color: #262626; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 1;
        }
        .calendar-day:hover { transform: scale(1.2); z-index: 10; border: 1px solid white; }
        .calendar-day.empty { background-color: transparent; cursor: default; }
        .calendar-day.empty:hover { transform: none; border: none; }
        
        /* Heatmap Levels */
        .level-0 { background-color: #262626; color: #666; }
        .level-1 { background-color: #4a3728; color: #fff; }
        .level-2 { background-color: #78350f; color: #fff; }
        .level-3 { background-color: #991b1b; color: #fff; }
        .level-4 { background-color: #ef4444; color: #fff; box-shadow: 0 0 5px rgba(239, 68, 68, 0.4); }

        /* --- LIVE FEED STYLES --- */
        .feed-container {
            overflow-y: auto;
            scrollbar-width: none;
        }
        .feed-item {
            animation: slideIn 0.5s ease-out forwards;
        }
        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        #dynamic-tooltip {
            position: fixed;
            background: rgba(20, 20, 22, 0.95);
            color: white;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            z-index: 9999;
            border: 1px solid rgba(255,255,255,0.15);
            transform: translate(-50%, -100%);
            margin-top: -15px;
            font-weight: 500;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Map Legend Overlay */
        .map-legend-overlay {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 10px;
            z-index: 20;
        }

        /* Tab Transitions */
        .tab-content {
            display: none !important; 
        }
        .tab-content.active {
            display: block !important;
            animation: fadeIn 0.5s ease-out;
        }
        #tab-awards.active {
            display: flex !important;
        }
        
        /* Full screen overlay tab for Activity */
        #tab-activity.active {
            display: block !important;
            position: fixed;
            top: 64px; /* offset navbar */
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 40;
            background-color: #050505;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased selection:bg-accent selection:text-white">

    <!-- Navbar -->
    <nav class="glass-nav fixed w-full z-50 transition-all duration-300 border-b border-white/10 h-16">
        <div class="max-w-screen-xl mx-auto px-4 md:px-6 h-full flex items-center justify-between">
            <!-- Logo & Brand -->
            <div class="flex items-center gap-3">
                <img src="traffy_logo.png" alt="Traffy Fondue" class="h-8 md:h-10 w-auto object-contain bg-white rounded-lg p-1" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <div class="bg-fondue text-white w-8 h-8 rounded-xl flex items-center justify-center shadow-lg hidden">
                    <i class="fa-solid fa-layer-group text-sm"></i>
                </div>
                <span class="font-bold text-lg tracking-tight text-white block">Fondue Award</span>
            </div>

            <!-- Navigation Tabs -->
            <div class="flex space-x-4 md:space-x-6 text-sm font-medium overflow-x-auto no-scrollbar h-full items-center">
                <button onclick="switchTab('stats')" id="nav-stats" class="nav-link text-white border-b-2 border-accent hover:text-white transition whitespace-nowrap h-full px-2 flex items-center">สถิติของระบบ</button>
                <button onclick="switchTab('activity')" id="nav-activity" class="nav-link text-text-secondary border-b-2 border-transparent hover:text-white transition whitespace-nowrap h-full px-2 flex items-center">กิจกรรมล่าสุด</button>
                <button onclick="switchTab('awards')" id="nav-awards" class="nav-link text-text-secondary border-b-2 border-transparent hover:text-white transition whitespace-nowrap h-full px-2 flex items-center">ประกาศรางวัล</button>
            </div>
        </div>
    </nav>

    <div id="dynamic-tooltip"></div>

    <!-- Main Content Wrapper -->
    <div class="pt-24 md:pt-32 pb-12 px-4 md:px-6 max-w-screen-xl mx-auto">
        
        <!-- ============================================== -->
        <!-- TAB 1: สถิติของระบบ (SYSTEM STATS)               -->
        <!-- ============================================== -->
        <div id="tab-stats" class="tab-content active">
            
            <!-- Hero Section -->
            <div class="flex flex-col xl:flex-row gap-6 md:gap-10 mb-8 md:mb-12">
                <div class="xl:w-1/3 flex flex-col justify-center text-center xl:text-left">
                    <div class="inline-flex items-center justify-center xl:justify-start gap-2 mb-2 md:mb-4">
                        <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
                        <span id="update-time" class="text-xs font-bold tracking-widest text-text-secondary uppercase">ข้อมูล ณ วันที่...</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold leading-tight mb-3 md:mb-4 text-white">พลังข้อมูล<br><span class="text-fondue-accent">เปลี่ยนประเทศไทย</span></h1>
                    <p class="text-text-secondary text-sm md:text-lg mb-6 md:mb-8 font-light leading-relaxed hidden md:block">ติดตามสถิติการแก้ไขปัญหาจากทุกหน่วยงานรัฐทั่วประเทศ ผ่านระบบโปร่งใสและตรวจสอบได้</p>
                </div>

                <!-- Hero Stats Grid -->
                <div class="xl:w-2/3" id="stats-grid">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Total Tickets -->
                        <div class="bento-card md:col-span-2 rounded-3xl p-6 md:p-8 bg-fondue text-white shadow-2xl relative overflow-hidden flex flex-col justify-between min-h-[180px] md:min-h-[220px]">
                            <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl translate-x-1/2 -translate-y-1/2"></div>
                            <div class="relative z-10">
                                <h3 class="text-lg font-medium text-white/90 mb-4 md:mb-6">เรื่องแจ้งทั้งหมด</h3>
                                <div class="flex items-baseline gap-2 mb-2">
                                    <span class="text-5xl md:text-7xl font-bold tracking-tight counter" data-target="1808598">0</span>
                                </div>
                                <p class="text-white/60 text-sm">เรื่องร้องเรียนสะสมทั่วประเทศ</p>
                            </div>
                        </div>
                        <!-- Efficiency -->
                        <div class="bento-card md:col-span-1 rounded-3xl p-6 bg-dark-surface flex flex-col items-center justify-center text-center relative min-h-[180px] md:min-h-[220px]">
                            <div class="relative w-28 h-28 md:w-36 md:h-36 mb-4 md:mb-6">
                                <svg class="w-full h-full transform -rotate-90">
                                    <circle cx="50%" cy="50%" r="45%" stroke="#2c2c2e" stroke-width="10" fill="transparent" />
                                    <circle id="progress-circle" cx="50%" cy="50%" r="45%" stroke="#34C759" stroke-width="10" fill="transparent" stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" class="transition-all duration-[2000ms] ease-out" />
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <div class="flex items-baseline">
                                        <span class="text-3xl md:text-4xl font-bold text-white counter" data-target="77">0</span>
                                        <span class="text-base md:text-lg font-bold text-success ml-0.5">%</span>
                                    </div>
                                </div>
                            </div>
                            <h3 class="text-lg md:text-xl font-bold text-white mb-1">แก้ไขเสร็จสิ้น</h3>
                            <p class="text-text-secondary text-xs">อัตราการจัดการปัญหาสำเร็จ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thailand Map & List -->
            <section class="py-6 md:py-12 bg-dark-surface rounded-3xl px-4 md:px-8 mb-16 border border-white/5">
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Left/Top: Map + Legend -->
                    <div class="lg:w-1/2 flex flex-col">
                        <div class="mb-4 relative flex justify-between items-center">
                            <h2 class="text-xl md:text-2xl font-bold text-white">พื้นที่ครอบคลุม</h2>
                            <button onclick="replayMapAnimation()" class="text-xs bg-white/10 hover:bg-blue-500 hover:text-white text-white px-3 py-1.5 rounded-full transition flex items-center gap-1"><i class="fa-solid fa-rotate-right"></i> รีเซ็ต</button>
                        </div>
                        
                        <div class="map-wrapper rounded-2xl overflow-hidden border border-white/5 bg-black/30 w-full" id="map-container">
                            <svg id="thailand-svg" width="400" height="600" viewBox="0 0 400 600" xmlns="http://www.w3.org/2000/svg">
                                <g transform="translate(-105, 30) scale(14)" class="map-group">
                                    <g id="Chiang_Rai" class="province"><title>เชียงราย</title><circle cx="16" cy="2"/><circle cx="17" cy="2"/><circle cx="17" cy="3"/><circle cx="18" cy="3"/></g>
                                    <g id="Chiang_Mai" class="province"><title>เชียงใหม่</title><circle cx="13" cy="3"/><circle cx="14" cy="3"/><circle cx="15" cy="3"/><circle cx="13" cy="4"/><circle cx="14" cy="4"/><circle cx="15" cy="4"/><circle cx="13" cy="5"/><circle cx="14" cy="5"/></g>
                                    <g id="Mae_Hong_Son" class="province"><title>แม่ฮ่องสอน</title><circle cx="11" cy="4"/><circle cx="12" cy="4"/><circle cx="11" cy="5"/><circle cx="12" cy="5"/><circle cx="11" cy="6"/><circle cx="12" cy="6"/></g>
                                    <g id="Phayao" class="province"><title>พะเยา</title><circle cx="18" cy="4"/><circle cx="19" cy="4"/><circle cx="18" cy="5"/></g>
                                    <g id="Nan" class="province"><title>น่าน</title><circle cx="19" cy="5"/><circle cx="20" cy="5"/><circle cx="19" cy="6"/><circle cx="20" cy="6"/><circle cx="20" cy="7"/></g>
                                    <g id="Lamphun" class="province"><title>ลำพูน</title><circle cx="14" cy="6"/><circle cx="15" cy="6"/></g>
                                    <g id="Lampang" class="province"><title>ลำปาง</title><circle cx="16" cy="5"/><circle cx="17" cy="5"/><circle cx="16" cy="6"/><circle cx="17" cy="6"/></g>
                                    <g id="Phrae" class="province"><title>แพร่</title><circle cx="18" cy="6"/><circle cx="19" cy="7"/><circle cx="18" cy="7"/></g>
                                    <g id="Tak" class="province"><title>ตาก</title><circle cx="12" cy="7"/><circle cx="13" cy="7"/><circle cx="12" cy="8"/><circle cx="13" cy="8"/><circle cx="11" cy="9"/><circle cx="12" cy="9"/><circle cx="11" cy="10"/><circle cx="12" cy="10"/><circle cx="11" cy="11"/></g>
                                    <g id="Sukhothai" class="province"><title>สุโขทัย</title><circle cx="15" cy="7"/><circle cx="16" cy="7"/><circle cx="15" cy="8"/></g>
                                    <g id="Uttaradit" class="province"><title>อุตรดิตถ์</title><circle cx="18" cy="8"/><circle cx="19" cy="8"/><circle cx="20" cy="8"/></g>
                                    <g id="Phitsanulok" class="province"><title>พิษณุโลก</title><circle cx="17" cy="8"/><circle cx="17" cy="9"/><circle cx="18" cy="9"/><circle cx="19" cy="9"/></g>
                                    <g id="Kamphaeng_Phet" class="province"><title>กำแพงเพชร</title><circle cx="14" cy="8"/><circle cx="14" cy="9"/><circle cx="15" cy="9"/><circle cx="15" cy="10"/></g>
                                    <g id="Phichit" class="province"><title>พิจิตร</title><circle cx="16" cy="9"/><circle cx="16" cy="10"/><circle cx="17" cy="10"/></g>
                                    <g id="Phetchabun" class="province"><title>เพชรบูรณ์</title><circle cx="18" cy="10"/><circle cx="19" cy="10"/><circle cx="18" cy="11"/><circle cx="19" cy="11"/><circle cx="18" cy="12"/></g>
                                    <g id="Nakhon_Sawan" class="province"><title>นครสวรรค์</title><circle cx="15" cy="11"/><circle cx="16" cy="11"/><circle cx="15" cy="12"/><circle cx="16" cy="12"/><circle cx="17" cy="12"/></g>
                                    <g id="Uthai_Thani" class="province"><title>อุทัยธานี</title><circle cx="13" cy="11"/><circle cx="14" cy="11"/><circle cx="13" cy="12"/></g>
                                    <g id="Loei" class="province"><title>เลย</title><circle cx="20" cy="9"/><circle cx="21" cy="9"/><circle cx="20" cy="10"/><circle cx="21" cy="10"/></g>
                                    <g id="Nong_Khai" class="province"><title>หนองคาย</title><circle cx="22" cy="9"/><circle cx="23" cy="9"/><circle cx="24" cy="9"/></g>
                                    <g id="Bueng_Kan" class="province"><title>บึงกาฬ</title><circle cx="25" cy="9"/><circle cx="26" cy="9"/><circle cx="27" cy="9"/></g>
                                    <g id="Nong_Bua_Lamphu" class="province"><title>หนองบัวลำภู</title><circle cx="22" cy="10"/></g>
                                    <g id="Udon_Thani" class="province"><title>อุดรธานี</title><circle cx="23" cy="10"/><circle cx="24" cy="10"/><circle cx="25" cy="10"/></g>
                                    <g id="Sakon_Nakhon" class="province"><title>สกลนคร</title><circle cx="26" cy="10"/><circle cx="27" cy="10"/><circle cx="28" cy="10"/></g>
                                    <g id="Nakhon_Phanom" class="province"><title>นครพนม</title><circle cx="29" cy="10"/><circle cx="29" cy="11"/><circle cx="30" cy="11"/></g>
                                    <g id="Mukdahan" class="province"><title>มุกดาหาร</title><circle cx="28" cy="12"/><circle cx="29" cy="12"/></g>
                                    <g id="Kalasin" class="province"><title>กาฬสินธุ์</title><circle cx="26" cy="11"/><circle cx="27" cy="11"/></g>
                                    <g id="Khon_Kaen" class="province"><title>ขอนแก่น</title><circle cx="23" cy="11"/><circle cx="24" cy="11"/><circle cx="25" cy="11"/><circle cx="24" cy="12"/><circle cx="25" cy="12"/></g>
                                    <g id="Chaiyaphum" class="province"><title>ชัยภูมิ</title><circle cx="21" cy="11"/><circle cx="22" cy="11"/><circle cx="21" cy="12"/><circle cx="22" cy="12"/><circle cx="21" cy="13"/></g>
                                    <g id="Maha_Sarakham" class="province"><title>มหาสารคาม</title><circle cx="26" cy="12"/></g>
                                    <g id="Roi_Et" class="province"><title>ร้อยเอ็ด</title><circle cx="27" cy="12"/><circle cx="27" cy="13"/><circle cx="28" cy="13"/></g>
                                    <g id="Yasothon" class="province"><title>ยโสธร</title><circle cx="29" cy="13"/></g>
                                    <g id="Amnat_Charoen" class="province"><title>อำนาจเจริญ</title><circle cx="30" cy="13"/><circle cx="31" cy="13"/></g>
                                    <g id="Ubon_Ratchathani" class="province"><title>อุบลราชธานี</title><circle cx="30" cy="14"/><circle cx="31" cy="14"/><circle cx="32" cy="14"/><circle cx="31" cy="15"/><circle cx="32" cy="15"/><circle cx="33" cy="15"/></g>
                                    <g id="Sisaket" class="province"><title>ศรีสะเกษ</title><circle cx="28" cy="14"/><circle cx="29" cy="14"/><circle cx="28" cy="15"/><circle cx="29" cy="15"/></g>
                                    <g id="Surin" class="province"><title>สุรินทร์</title><circle cx="26" cy="14"/><circle cx="27" cy="14"/><circle cx="26" cy="15"/><circle cx="27" cy="15"/></g>
                                    <g id="Buriram" class="province"><title>บุรีรัมย์</title><circle cx="24" cy="13"/><circle cx="25" cy="13"/><circle cx="24" cy="14"/><circle cx="25" cy="14"/></g>
                                    <g id="Nakhon_Ratchasima" class="province"><title>นครราชสีมา</title><circle cx="21" cy="14"/><circle cx="22" cy="14"/><circle cx="23" cy="14"/><circle cx="21" cy="15"/><circle cx="22" cy="15"/><circle cx="23" cy="15"/></g>
                                    <g id="Chai_Nat" class="province"><title>ชัยนาท</title><circle cx="15" cy="13"/><circle cx="16" cy="13"/></g>
                                    <g id="Sing_Buri" class="province"><title>สิงห์บุรี</title><circle cx="16" cy="14"/></g>
                                    <g id="Lopburi" class="province"><title>ลพบุรี</title><circle cx="17" cy="13"/><circle cx="18" cy="13"/><circle cx="17" cy="14"/></g>
                                    <g id="Ang_Thong" class="province"><title>อ่างทอง</title><circle cx="16" cy="15"/></g>
                                    <g id="Saraburi" class="province"><title>สระบุรี</title><circle cx="18" cy="14"/><circle cx="19" cy="14"/><circle cx="18" cy="15"/></g>
                                    <g id="Suphan_Buri" class="province"><title>สุพรรณบุรี</title><circle cx="14" cy="14"/><circle cx="15" cy="14"/><circle cx="14" cy="15"/><circle cx="15" cy="15"/></g>
                                    <g id="Kanchanaburi" class="province"><title>กาญจนบุรี</title><circle cx="11" cy="12"/><circle cx="12" cy="12"/><circle cx="11" cy="13"/><circle cx="12" cy="13"/><circle cx="11" cy="14"/><circle cx="12" cy="14"/><circle cx="13" cy="14"/><circle cx="11" cy="15"/><circle cx="12" cy="15"/></g>
                                    <g id="Ayutthaya" class="province"><title>พระนครศรีอยุธยา</title><circle cx="16" cy="16"/><circle cx="17" cy="16"/></g>
                                    <g id="Nakhon_Pathom" class="province"><title>นครปฐม</title><circle cx="15" cy="16"/><circle cx="15" cy="17"/></g>
                                    <g id="Pathum_Thani" class="province"><title>ปทุมธานี</title><circle cx="16" cy="17"/><circle cx="17" cy="17"/></g>
                                    <g id="Nonthaburi" class="province"><title>นนทบุรี</title><circle cx="16" cy="18"/></g>
                                    <g id="Bangkok" class="province"><title>กรุงเทพมหานคร</title><circle cx="17" cy="18"/><circle cx="18" cy="18"/></g>
                                    <g id="Samut_Prakan" class="province"><title>สมุทรปราการ</title><circle cx="17" cy="19"/><circle cx="18" cy="19"/></g>
                                    <g id="Samut_Sakhon" class="province"><title>สมุทรสาคร</title><circle cx="16" cy="19"/></g>
                                    <g id="Samut_Songkhram" class="province"><title>สมุทรสงคราม</title><circle cx="15" cy="19"/></g>
                                    <g id="Nakhon_Nayok" class="province"><title>นครนายก</title><circle cx="19" cy="15"/><circle cx="20" cy="15"/></g>
                                    <g id="Prachin_Buri" class="province"><title>ปราจีนบุรี</title><circle cx="20" cy="16"/><circle cx="21" cy="16"/></g>
                                    <g id="Sa_Kaeo" class="province"><title>สระแก้ว</title><circle cx="22" cy="16"/><circle cx="23" cy="16"/><circle cx="24" cy="16"/></g>
                                    <g id="Chachoengsao" class="province"><title>ฉะเชิงเทรา</title><circle cx="19" cy="16"/><circle cx="19" cy="17"/><circle cx="20" cy="17"/></g>
                                    <g id="Chonburi" class="province"><title>ชลบุรี</title><circle cx="18" cy="20"/><circle cx="19" cy="20"/><circle cx="19" cy="21"/></g>
                                    <g id="Rayong" class="province"><title>ระยอง</title><circle cx="20" cy="21"/><circle cx="21" cy="21"/></g>
                                    <g id="Chanthaburi" class="province"><title>จันทบุรี</title><circle cx="22" cy="20"/><circle cx="22" cy="21"/><circle cx="23" cy="21"/></g>
                                    <g id="Trat" class="province"><title>ตราด</title><circle cx="23" cy="22"/><circle cx="24" cy="22"/><circle cx="24" cy="23"/></g>
                                    <g id="Ratchaburi" class="province"><title>ราชบุรี</title><circle cx="13" cy="16"/><circle cx="14" cy="16"/><circle cx="13" cy="17"/><circle cx="14" cy="17"/><circle cx="13" cy="18"/><circle cx="14" cy="18"/></g>
                                    <g id="Phetchaburi" class="province"><title>เพชรบุรี</title><circle cx="13" cy="19"/><circle cx="14" cy="19"/><circle cx="13" cy="20"/><circle cx="14" cy="20"/></g>
                                    <g id="Prachuap_Khiri_Khan" class="province"><title>ประจวบคีรีขันธ์</title><circle cx="13" cy="21"/><circle cx="14" cy="21"/><circle cx="13" cy="22"/><circle cx="13" cy="23"/><circle cx="14" cy="23"/><circle cx="13" cy="24"/><circle cx="13" cy="25"/></g>
                                    <g id="Chumphon" class="province"><title>ชุมพร</title><circle cx="13" cy="26"/><circle cx="14" cy="26"/><circle cx="13" cy="27"/><circle cx="14" cy="27"/></g>
                                    <g id="Ranong" class="province"><title>ระนอง</title><circle cx="12" cy="28"/><circle cx="13" cy="28"/><circle cx="12" cy="29"/></g>
                                    <g id="Surat_Thani" class="province"><title>สุราษฎร์ธานี</title><circle cx="14" cy="28"/><circle cx="15" cy="28"/><circle cx="14" cy="29"/><circle cx="15" cy="29"/><circle cx="16" cy="29"/><circle cx="14" cy="30"/><circle cx="15" cy="30"/></g>
                                    <g id="Phang_Nga" class="province"><title>พังงา</title><circle cx="13" cy="30"/><circle cx="13" cy="31"/><circle cx="14" cy="31"/></g>
                                    <g id="Phuket" class="province"><title>ภูเก็ต</title><circle cx="13" cy="32"/></g>
                                    <g id="Krabi" class="province"><title>กระบี่</title><circle cx="14" cy="32"/><circle cx="15" cy="32"/></g>
                                    <g id="Nakhon_Si_Thammarat" class="province"><title>นครศรีธรรมราช</title><circle cx="16" cy="30"/><circle cx="17" cy="30"/><circle cx="16" cy="31"/><circle cx="17" cy="31"/><circle cx="16" cy="32"/><circle cx="17" cy="32"/></g>
                                    <g id="Trang" class="province"><title>ตรัง</title><circle cx="15" cy="33"/><circle cx="16" cy="33"/></g>
                                    <g id="Phatthalung" class="province"><title>พัทลุง</title><circle cx="17" cy="33"/><circle cx="17" cy="34"/></g>
                                    <g id="Satun" class="province"><title>สตูล</title><circle cx="15" cy="34"/><circle cx="16" cy="34"/></g>
                                    <g id="Songkhla" class="province"><title>สงขลา</title><circle cx="18" cy="34"/><circle cx="19" cy="34"/><circle cx="18" cy="35"/><circle cx="19" cy="35"/></g>
                                    <g id="Pattani" class="province"><title>ปัตตานี</title><circle cx="20" cy="35"/><circle cx="21" cy="35"/></g>
                                    <g id="Yala" class="province"><title>ยะลา</title><circle cx="19" cy="36"/><circle cx="20" cy="36"/><circle cx="20" cy="37"/></g>
                                    <g id="Narathiwat" class="province"><title>นราธิวาส</title><circle cx="21" cy="36"/><circle cx="22" cy="36"/><circle cx="21" cy="37"/></g>
                                </g>
                            </svg>
                            
                             <!-- Legend Overlay -->
                             <div class="map-legend-overlay flex flex-col gap-2">
                                 <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-success shadow-[0_0_8px_rgba(52,199,89,0.5)]"></span><span class="text-white flex-1 flex justify-between gap-4">ครบทุกหน่วยราชการ <span id="count-completed" class="font-mono text-accent">0</span></span></div>
                                 <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-pending shadow-[0_0_8px_rgba(255,159,10,0.5)]"></span><span class="text-white flex-1 flex justify-between gap-4">รอการอบรม <span id="count-pending" class="font-mono text-accent">0</span></span></div>
                                 <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-partial shadow-[0_0_8px_rgba(0,0,0,0.5)]"></span><span class="text-white flex-1 flex justify-between gap-4">ใช้งานบางพื้นที่ <span id="count-partial" class="font-mono text-accent">0</span></span></div>
                             </div>
                        </div>
                    </div>

                    <!-- Right/Bottom: Filter & List -->
                    <div class="lg:w-1/2 flex flex-col h-auto md:h-[600px] bg-black/20 rounded-2xl border border-white/5 overflow-hidden">
                         <div class="p-4 border-b border-white/10 bg-dark-surface/80 backdrop-blur z-10 sticky top-0">
                            <div class="relative mb-0">
                                <i class="fa-solid fa-search absolute left-3 top-3 text-text-secondary text-xs"></i>
                                <input type="text" id="province-search" placeholder="ค้นหา / แนะนำจังหวัด..." class="w-full bg-black/30 border border-white/10 rounded-lg py-2.5 pl-9 pr-4 text-sm text-white focus:outline-none focus:border-accent/50 placeholder-text-secondary/50">
                            </div>
                         </div>
                         <div class="flex-1 overflow-y-auto custom-scroll p-4 pb-20 relative" id="province-list-container"></div>
                    </div>
                </div>
            </section>

            <!-- City Pulse: Calendar View (3 Months) -->
            <section class="mb-16 bento-card rounded-3xl p-6 md:p-8 bg-dark-surface border border-white/5 overflow-hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h3 class="text-xl font-bold text-white">จังหวะชีวิตของเมือง (City Pulse)</h3>
                        <p class="text-text-secondary text-sm">ความหนาแน่นของการแจ้งเหตุ 3 เดือนล่าสุด</p>
                    </div>
                    
                    <div class="flex flex-col items-end gap-3 w-full md:w-auto">
                        <!-- Legend Range -->
                        <div class="flex items-center gap-2 text-[10px] text-text-secondary font-mono mt-1">
                            <span>0</span>
                            <div class="flex gap-1">
                                <div class="w-3 h-3 rounded-[2px] level-0"></div>
                                <div class="w-3 h-3 rounded-[2px] level-1" title="1-100 เรื่อง"></div>
                                <div class="w-3 h-3 rounded-[2px] level-2" title="101-200 เรื่อง"></div>
                                <div class="w-3 h-3 rounded-[2px] level-3" title="201-300 เรื่อง"></div>
                                <div class="w-3 h-3 rounded-[2px] level-4" title="300+ เรื่อง"></div>
                            </div>
                            <span>300+ เรื่อง</span>
                        </div>
                    </div>
                </div>
                
                <!-- 3 Month Calendar Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Month 1 -->
                    <div id="month-wrapper-0">
                        <div class="text-white text-sm font-bold mb-3 flex justify-between">
                            <span id="month-title-0">ธันวาคม 2568</span>
                        </div>
                        <div class="grid grid-cols-7 gap-1 mb-2 text-center text-[10px] text-text-secondary font-bold">
                            <span>อา</span><span>จ</span><span>อ</span><span>พ</span><span>พฤ</span><span>ศ</span><span>ส</span>
                        </div>
                        <div id="calendar-month-0" class="calendar-month-grid"></div>
                    </div>

                    <!-- Month 2 -->
                    <div id="month-wrapper-1">
                        <div class="text-white text-sm font-bold mb-3 flex justify-between">
                            <span id="month-title-1">มกราคม 2569</span>
                        </div>
                        <div class="grid grid-cols-7 gap-1 mb-2 text-center text-[10px] text-text-secondary font-bold">
                            <span>อา</span><span>จ</span><span>อ</span><span>พ</span><span>พฤ</span><span>ศ</span><span>ส</span>
                        </div>
                        <div id="calendar-month-1" class="calendar-month-grid"></div>
                    </div>

                    <!-- Month 3 -->
                    <div id="month-wrapper-2">
                        <div class="text-white text-sm font-bold mb-3 flex justify-between">
                            <span id="month-title-2">กุมภาพันธ์ 2569</span>
                        </div>
                        <div class="grid grid-cols-7 gap-1 mb-2 text-center text-[10px] text-text-secondary font-bold">
                            <span>อา</span><span>จ</span><span>อ</span><span>พ</span><span>พฤ</span><span>ศ</span><span>ส</span>
                        </div>
                        <div id="calendar-month-2" class="calendar-month-grid"></div>
                    </div>
                </div>
            </section>
        </div>

    </div><!-- End of main container (Stats and Awards) -->

    <!-- ============================================== -->
    <!-- TAB 2: กิจกรรมล่าสุด (FULL SCREEN MAP)           -->
    <!-- ============================================== -->
    <div id="tab-activity" class="tab-content hidden">
        <!-- The background map layer -->
        <div class="absolute inset-0 z-0">
            <!-- OpenStreetMap (Leaflet) -->
            <div id="osm-map" class="w-full h-full absolute inset-0 z-0"></div>
            
            <!-- Live Target Highlight Info -->
            <div id="live-target-info" class="absolute top-12 left-1/2 transform -translate-x-1/2 bg-black/80 backdrop-blur-md border border-accent/50 px-6 py-3 rounded-full opacity-0 transition-opacity duration-500 text-center z-20 pointer-events-none shadow-[0_0_20px_rgba(96,165,250,0.3)]">
                <div class="text-accent font-bold text-lg" id="live-target-prov">กำลังค้นหาพิกัด...</div>
            </div>
        </div>

        <!-- Floating UI Overlay -->
        <div class="absolute inset-0 z-30 pointer-events-none p-4 md:p-6 flex flex-col md:flex-row justify-between items-end md:items-stretch">
            
            <!-- Top Left: Title -->
            <div class="absolute top-4 left-4 md:top-6 md:left-6 flex flex-col gap-4 pointer-events-auto">
                <div class="bg-dark-surface/90 backdrop-blur-md p-4 md:p-6 rounded-3xl border border-white/10 shadow-2xl">
                    <h2 class="text-xl md:text-3xl font-bold text-white">กิจกรรมล่าสุดแบบเรียลไทม์</h2>
                    <p class="text-text-secondary text-xs md:text-sm mt-1">เกาะติดสถานการณ์ทุกพื้นที่ทั่วไทย</p>
                </div>
            </div>

            <!-- Right Side / Bottom: Feeds Panel -->
            <div class="pointer-events-auto w-full md:w-[380px] lg:w-[420px] flex flex-col gap-4 h-[50vh] md:h-full justify-end md:justify-start absolute bottom-4 left-4 right-4 md:relative md:left-auto md:right-auto md:bottom-auto">
                
                <!-- Activity Feed Card -->
                <div class="bg-dark-surface/85 backdrop-blur-md border border-white/10 rounded-3xl p-5 flex flex-col flex-1 min-h-0 shadow-2xl">
                    <div class="flex items-center gap-3 mb-4 shrink-0">
                        <div class="w-2 h-2 rounded-full bg-accent animate-ping"></div>
                        <h3 class="font-bold text-white text-lg">กิจกรรมล่าสุดในระบบ</h3>
                    </div>
                    <div id="activity-feed" class="feed-container no-scrollbar space-y-3 overflow-y-auto flex-1 pr-2"></div>
                </div>

                <!-- Testimonials Card -->
                <div class="bg-fondue/85 backdrop-blur-md border border-white/10 rounded-3xl p-5 flex flex-col flex-1 min-h-0 shadow-2xl relative overflow-hidden">
                    <div class="absolute -top-10 -right-10 w-40 h-40 bg-accent/10 blur-3xl rounded-full pointer-events-none"></div>
                    <div class="flex items-center gap-3 mb-4 shrink-0 relative z-10">
                        <i class="fa-solid fa-heart text-red-500 animate-pulse"></i>
                        <h3 class="font-bold text-white text-lg">เสียงสะท้อนจากประชาชน</h3>
                    </div>
                    <div id="testimonial-feed" class="feed-container no-scrollbar space-y-3 overflow-y-auto flex-1 relative z-10 pr-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- TAB 3: ประกาศรางวัล (AWARDS)                     -->
    <!-- ============================================== -->
    <div id="tab-awards" class="tab-content pt-32 pb-12 px-4 max-w-screen-xl mx-auto h-[70vh] items-center justify-center text-center">
        <div class="flex flex-col items-center justify-center h-full">
            <div class="text-accent text-6xl mb-6 relative inline-block">
                <i class="fa-solid fa-person-digging relative z-10"></i>
                <div class="absolute inset-0 bg-accent/30 blur-2xl rounded-full"></div>
            </div>
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">Under Construction</h2>
            <p class="text-text-secondary text-base md:text-lg max-w-md mx-auto">
                หน้าประกาศรางวัลประจำปี กำลังอยู่ระหว่างการรวบรวมข้อมูลและพัฒนาระบบ จะเปิดให้ใช้งานได้ในเร็วๆ นี้ครับ
            </p>
        </div>
    </div>

    <script>
        // --- DATA & CONSTANTS ---
        const aliasMap = { "กรุงเทพมหานคร": "กทม.", "พระนครศรีอยุธยา": "อยุธยา" };
        const statusLabels = { 
            'completed': '<span class="text-success">ครบทุกหน่วยราชการ</span>', 
            'pending': '<span class="text-pending">รอการอบรม</span>', 
            'partial': '<span class="text-white/60">ใช้งานบางพื้นที่</span>' 
        };

        const provinceData = {
            "เชียงราย": { date: "7 ก.พ. 68", status: "completed" }, "แม่ฮ่องสอน": { date: "ประสานวันอบรม", status: "pending" }, "เชียงใหม่": { date: "16 มิ.ย. 66", status: "completed" }, "พะเยา": { date: "9 พ.ย. 65", status: "completed" }, "น่าน": { date: "8 ส.ค. 67", status: "completed" }, "ลำพูน": { date: "25 พ.ย. 65", status: "completed" }, "ลำปาง": { date: "24 ก.ค. 66", status: "completed" }, "แพร่": { date: "-", status: "partial" }, "อุตรดิตถ์": { date: "25 มี.ค. 67", status: "completed" }, "สุโขทัย": { date: "-", status: "partial" }, "ตาก": { date: "11 พ.ย. 67", status: "completed" }, "กำแพงเพชร": { date: "-", status: "partial" }, "พิษณุโลก": { date: "-", status: "partial" }, "พิจิตร": { date: "-", status: "partial" }, "เพชรบูรณ์": { date: "10-13 ม.ค. 66", status: "completed" }, "นครสวรรค์": { date: "18 ก.ค. 68", status: "completed" }, "อุทัยธานี": { date: "ประสานวันอบรม", status: "pending" },
            "เลย": { date: "-", status: "partial" }, "หนองคาย": { date: "12 ธ.ค. 68", status: "completed" }, "บึงกาฬ": { date: "-", status: "partial" }, "หนองบัวลำภู": { date: "28 พ.ย. 68", status: "completed" }, "อุดรธานี": { date: "18 มี.ค. 67", status: "completed" }, "สกลนคร": { date: "ประสานวันอบรม", status: "pending" }, "นครพนม": { date: "14 ก.พ. 68", status: "completed" }, "ชัยภูมิ": { date: "-", status: "partial" }, "ขอนแก่น": { date: "4 พ.ย. 65", status: "completed" }, "กาฬสินธุ์": { date: "เม.ย 69", status: "pending" }, "มุกดาหาร": { date: "-", status: "partial" }, "มหาสารคาม": { date: "29 ส.ค. 68", status: "completed" }, "ร้อยเอ็ด": { date: "-", status: "partial" }, "ยโสธร": { date: "23 ก.พ. 67", status: "completed" }, "อำนาจเจริญ": { date: "-", status: "partial" }, "Surin": { date: "-", status: "partial" }, "ศรีสะเกษ": { date: "-", status: "partial" }, "สุรินทร์": { date: "-", status: "partial" }, "บุรีรัมย์": { date: "-", status: "partial" }, "นครราชสีมา": { date: "2 ส.ค. 65", status: "completed" },
            "กาญจนบุรี": { date: "-", status: "partial" }, "สุพรรณบุรี": { date: "23 ม.ค. 69", status: "completed" }, "ชัยนาท": { date: "-", status: "partial" }, "สิงห์บุรี": { date: "28-29 ส.ค. 66", status: "completed" }, "ลพบุรี": { date: "-", status: "partial" }, "อ่างทอง": { date: "-", status: "partial" }, "สระบุรี": { date: "24-25 เม.ย. 66", status: "completed" }, "อยุธยา": { date: "24 ธ.ค. 68", status: "completed" }, "ปทุมธานี": { date: "-", status: "partial" }, "นนทบุรี": { date: "24 ต.ค. 66", status: "completed" }, "นครปฐม": { date: "26 พ.ค. 68", status: "completed" }, "ราชบุรี": { date: "-", status: "partial" }, "สมุทรสงคราม": { date: "-", status: "partial" }, "สมุทรสาคร": { date: "11 มี.ค. 67", status: "completed" }, "กทม.": { date: "10 มิ.ย. 65", status: "completed" }, "สมุทรปราการ": { date: "28 ก.พ - 1 มี.ค. 66", status: "completed" }, "นครนายก": { date: "-", status: "partial" }, "ปราจีนบุรี": { date: "30 พ.ย. 65", status: "completed" }, "สระแก้ว": { date: "-", status: "partial" }, "ฉะเชิงเทรา": { date: "-", status: "partial" }, "ชลบุรี": { date: "-", status: "partial" }, "ระยอง": { date: "13 พ.ค. 67", status: "completed" }, "จันทบุรี": { date: "-", status: "partial" }, "ตราด": { date: "6 ก.ย. 67", status: "completed" },
            "เพชรบุรี": { date: "-", status: "partial" }, "ประจวบคีรีขันธ์": { date: "-", status: "partial" }, "ชุมพร": { date: "-", status: "partial" }, "ระนอง": { date: "20 มี.ค. 68", status: "completed" }, "สุราษฎร์ธานี": { date: "-", status: "partial" }, "พังงา": { date: "-", status: "partial" }, "ภูเก็ต": { date: "19-20 ธ.ค. 65", status: "completed" }, "กระบี่": { date: "-", status: "partial" }, "นครศรีธรรมราช": { date: "-", status: "partial" }, "ตรัง": { date: "22 ก.ย. 66", status: "completed" }, "พัทลุง": { date: "-", status: "partial" }, "สตูล": { date: "-", status: "partial" }, "สงขลา": { date: "-", status: "partial" }, "ปัตตานี": { date: "-", status: "partial" }, "ยะลา": { date: "-", status: "partial" }, "นราธิวาส": { date: "9 มี.ค 69", status: "pending" }
        };

        const liveActivities = [
            { id: "Bangkok", org: "กทม.", action: "ได้รับแจ้ง", topic: "ทางเท้าชำรุด", color: "text-pending", coords: [13.7563, 100.5018] },
            { id: "Nonthaburi", org: "เทศบาลนครนนทบุรี", action: "แก้ไขเสร็จสิ้น", topic: "ขยะอุดตัน", color: "text-success", coords: [13.8591, 100.5217] },
            { id: "Chonburi", org: "อบจ.ชลบุรี", action: "เชิญหน่วยงานร่วม", topic: "สายไฟรกรุงรัง", color: "text-accent", coords: [13.3611, 100.9847] },
            { id: "Bangkok", org: "สน.ทองหล่อ", action: "รับแจ้ง", topic: "จอดรถกีดขวาง", color: "text-pending", coords: [13.7367, 100.5828] }, 
            { id: "Phuket", org: "เทศบาลเมืองภูเก็ต", action: "รับแจ้ง", topic: "ฝาท่อระบายน้ำหาย", color: "text-pending", coords: [7.8804, 98.3923] },
            { id: "Chiang_Mai", org: "กรมทางหลวง", action: "กำลังดำเนินการ", topic: "ไฟส่องสว่างดับ", color: "text-accent", coords: [18.7883, 98.9853] },
            { id: "Nakhon_Ratchasima", org: "เทศบาลนครราชสีมา", action: "แก้ไขเสร็จสิ้น", topic: "ถนนเป็นหลุมบ่อ", color: "text-success", coords: [14.9799, 102.0978] },
            { id: "Songkhla", org: "เทศบาลนครหาดใหญ่", action: "ได้รับแจ้ง", topic: "น้ำท่วมขัง", color: "text-pending", coords: [7.0096, 100.4736] } 
        ];
        
        const feedback = [
            { type: "ความสะอาด", title: "ขยะล้นถังหน้าตลาด", msg: "แจ้งปุ๊บมาเก็บปั๊บ ไวมากค่ะ" },
            { type: "ทางเท้า", title: "อิฐตัวหนอนกระดก", msg: "ซ่อมเสร็จแล้ว เดินสะดวกขึ้นเยอะครับ" },
            { type: "ไฟฟ้า", title: "ไฟกิ่งดับทั้งซอย", msg: "สว่างแล้ว อุ่นใจขึ้นมาก ขอบคุณครับ" },
            { type: "จราจร", title: "รถจอดขวางทางเข้าออก", msg: "เจ้าหน้าที่มาจัดการให้เร็วมาก" },
            { type: "ความปลอดภัย", title: "ฝาท่อชำรุดอันตราย", msg: "แก้ไขเรียบร้อย ปลอดภัยแล้วค่ะ" }
        ];

        // --- GLOBAL VARIABLES ---
        let osmMap;
        let osmMarker;
        let currentActivityIndex = 0;
        const listContainer = document.getElementById('province-list-container');
        const dynamicTooltip = document.getElementById('dynamic-tooltip');

        // --- UTILS ---
        function parseThaiDate(dateStr) {
            if (!dateStr || dateStr === "-" || dateStr.includes("ประสาน")) return new Date(9999, 11, 31);
            const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            const parts = dateStr.trim().split(' ');
            let year = 0;
            const yearStr = parts[parts.length - 1]; 
            const monthStr = parts[parts.length - 2];
            if (yearStr && !isNaN(parseInt(yearStr))) year = 2500 + parseInt(yearStr) - 543;
            const month = months.findIndex(m => monthStr && monthStr.includes(m)) || 0;
            return new Date(year, month, 1);
        }

        function updateTimestamp() {
            const timeEl = document.getElementById('update-time');
            if (timeEl) {
                const now = new Date();
                const dateStr = now.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
                timeEl.innerText = `ข้อมูล ณ วันที่ ${dateStr}`;
            }
        }

        // --- TAB SWITCHING LOGIC ---
        function switchTab(tabId) {
            // Hide all
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            // Show target
            document.getElementById('tab-' + tabId).classList.add('active');
            
            // Update nav styling
            document.querySelectorAll('.nav-link').forEach(el => {
                el.classList.remove('text-white', 'border-accent');
                el.classList.add('text-text-secondary', 'border-transparent');
            });
            
            const activeNav = document.getElementById('nav-' + tabId);
            activeNav.classList.remove('text-text-secondary', 'border-transparent');
            activeNav.classList.add('text-white', 'border-accent');

            // Re-trigger animations or fix map dimensions if necessary
            if (tabId === 'stats') {
                startCounters(document.getElementById('tab-stats'));
            } else if (tabId === 'activity') {
                if (osmMap) {
                    // Slight delay allows the container to be fully displayed before invalidating size.
                    setTimeout(() => { 
                        osmMap.invalidateSize(); 
                        triggerActivityMapPan(liveActivities[currentActivityIndex % liveActivities.length]); 
                    }, 100); 
                }
            }
        }

        // --- INITIALIZATION ---
        // Initialize immediately
        window.addEventListener('DOMContentLoaded', () => {
             updateTimestamp();
             
             // Initialize Leaflet
             initLeaflet();

             // Setup Default Tab
             startCounters(document.getElementById('tab-stats')); 

             // Render Calendars: Dec 2025, Jan 2026, Feb 2026
             renderMonth(2025, 11, 'calendar-month-0'); 
             renderMonth(2026, 0, 'calendar-month-1');  
             renderMonth(2026, 1, 'calendar-month-2');  

             playMapSequence();
             renderList();
             initFeeds();
             updateLegendCounts();
        });

        // Scroll Reveal
        window.addEventListener("scroll", () => {
            document.querySelectorAll(".reveal").forEach(el => {
                if (el.getBoundingClientRect().top < window.innerHeight - 50) {
                    el.classList.add("active");
                }
            });
        });

        // --- STATS COUNTER ---
        function startCounters(section) {
            if (!section) return;
            const counters = section.querySelectorAll('.counter');
            counters.forEach(counter => {
                let target = parseInt(counter.getAttribute('data-target'));
                if (isNaN(target)) return;
                
                const startTime = performance.now();
                const duration = 2000;

                function updateCount(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const ease = 1 - Math.pow(1 - progress, 4); 
                    const current = target * ease;
                    counter.innerText = Math.floor(current).toLocaleString();

                    if (progress < 1) requestAnimationFrame(updateCount);
                    else counter.innerText = target.toLocaleString();
                }
                requestAnimationFrame(updateCount);
            });
             const circle = section.querySelector('#progress-circle');
            if (circle) {
                circle.style.transition = 'none';
                circle.style.strokeDashoffset = '283';
                setTimeout(() => { 
                    circle.style.transition = 'all 2000ms ease-out';
                    circle.style.strokeDashoffset = '65'; 
                }, 50);
            }
        }

        // --- CALENDAR HEATMAP ---
        function renderMonth(year, monthIndex, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = "";
            
            const startDate = new Date(year, monthIndex, 1);
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const startDayOfWeek = startDate.getDay();
            
            for (let p = 0; p < startDayOfWeek; p++) {
                const pad = document.createElement('div');
                pad.className = 'calendar-day empty'; 
                container.appendChild(pad);
            }
            
            for(let i=1; i<=daysInMonth; i++) {
                const day = document.createElement('div');
                const level = Math.floor(Math.random() * 5); 
                const count = level === 0 ? 0 : level * 100 + Math.floor(Math.random() * 99);
                
                day.className = `calendar-day level-${level}`;
                day.innerText = i; 
                
                day.addEventListener('mousemove', (e) => {
                    const d = new Date(year, monthIndex, i);
                    dynamicTooltip.style.opacity = 1;
                    dynamicTooltip.innerHTML = `<strong>${d.toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'numeric'})}</strong><br><span class="text-xs font-mono">เรื่องแจ้ง: ${count.toLocaleString()}</span>`;
                    dynamicTooltip.style.left = e.pageX + 'px';
                    dynamicTooltip.style.top = (e.pageY - 10) + 'px';
                });
                day.addEventListener('mouseleave', () => dynamicTooltip.style.opacity = 0);
                
                container.appendChild(day);
            }
        }

        // --- LEAFLET MAP & TOGGLE ---
        function initLeaflet() {
            osmMap = L.map('osm-map', { zoomControl: false }).setView([13.7563, 100.5018], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(osmMap);

            const customIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="w-4 h-4 bg-accent rounded-full border-2 border-white shadow-[0_0_15px_rgba(96,165,250,1)] animate-pulse"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            osmMarker = L.marker([13.7563, 100.5018], {icon: customIcon}).addTo(osmMap);
        }

        // --- LIVE FEEDS & MAP PANNING ---
        function pushFeed(containerId, content, maxItems = 5) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const div = document.createElement('div');
            div.className = "feed-item p-4 mb-3 rounded-2xl bg-black/40 border border-white/5 text-sm shadow-lg";
            div.innerHTML = content;
            container.prepend(div);
            
            while (container.children.length > maxItems) {
                container.removeChild(container.lastChild);
            }
        }
        
        function triggerActivityMapPan(actData) {
            const overlay = document.getElementById('live-target-info');
            const overlayProv = document.getElementById('live-target-prov');

            // Pan OSM Mode
            // Only fly if map container has actual width/height to avoid Leaflet NaN errors
            const osmContainerElement = document.getElementById('osm-map');
            if (actData.coords && osmMap && osmContainerElement && osmContainerElement.clientWidth > 0 && osmContainerElement.clientHeight > 0) {
                try {
                    osmMap.flyTo(actData.coords, 9, { duration: 1.5 });
                    osmMarker.setLatLng(actData.coords);
                } catch(e) {
                    console.warn("Leaflet map flyTo error avoided: container might be hidden.", e);
                }
            }
            
            // Update Overlay
            overlayProv.innerHTML = `<i class="fa-solid fa-location-dot mr-1"></i> ${actData.org}`;
            overlay.style.opacity = 1;
            setTimeout(() => { overlay.style.opacity = 0; }, 2500);
        }

        function initFeeds() {
            for(let i=0; i<5; i++) {
                const act = liveActivities[i % liveActivities.length];
                const html = `
                    <div class="text-xs text-text-secondary mb-1"><i class="fa-solid fa-clock-rotate-left mr-1"></i> ${new Date().toLocaleTimeString()}</div>
                    <div class="text-white">หน่วยงาน <span class='text-accent font-medium'>${act.org}</span> <span class='${act.color} font-bold'>${act.action}</span> เรื่อง <span class='text-white'>${act.topic}</span></div>
                `;
                pushFeed('activity-feed', html, 5);
                
                const fb = feedback[i % feedback.length];
                pushFeed('testimonial-feed', `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-accent bg-accent/10 px-2 py-0.5 rounded text-xs">${fb.type}</span>
                        <span class="text-xs text-white font-medium truncate ml-2">${fb.title}</span>
                    </div>
                    <div class="italic text-white/80 leading-relaxed text-sm">"${fb.msg}"</div>
                `, 5);
            }
        }

        setInterval(() => {
            if(!document.getElementById('tab-activity').classList.contains('active')) return;

            const act = liveActivities[currentActivityIndex % liveActivities.length];
            const html = `
                <div class="text-xs text-text-secondary mb-1"><i class="fa-solid fa-clock-rotate-left mr-1"></i> ${new Date().toLocaleTimeString()}</div>
                <div class="text-white">หน่วยงาน <span class='text-accent font-medium'>${act.org}</span> <span class='${act.color} font-bold'>${act.action}</span> เรื่อง <span class='text-white'>${act.topic}</span></div>
            `;
            
            pushFeed('activity-feed', html, 5);
            triggerActivityMapPan(act); 
            
            if(Math.random() > 0.5) {
                const fb = feedback[Math.floor(Math.random() * feedback.length)];
                pushFeed('testimonial-feed', `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-accent bg-accent/10 px-2 py-0.5 rounded text-xs">${fb.type}</span>
                        <span class="text-xs text-white font-medium truncate ml-2">${fb.title}</span>
                    </div>
                    <div class="italic text-white/80 leading-relaxed text-sm">"${fb.msg}"</div>
                `, 5);
            }
            
            currentActivityIndex++;
        }, 4000);

        // --- STATS MAP LOGIC ---
        function updateLegendCounts() {
            const counts = { completed: 0, pending: 0, partial: 0 };
            Object.values(provinceData).forEach(d => {
                if (counts[d.status] !== undefined) counts[d.status]++;
                else counts['partial']++; 
            });
            document.getElementById('count-completed').innerText = counts.completed;
            document.getElementById('count-pending').innerText = counts.pending;
            document.getElementById('count-partial').innerText = counts.partial;
        }

        const mapGroupsList = [];

        document.querySelectorAll('#map-container .province').forEach(group => {
            let thaiName = group.querySelector('title')?.textContent.split(' ')[0] || "";
            if (aliasMap[thaiName]) thaiName = aliasMap[thaiName];
            group.dataset.province = thaiName;
            const info = provinceData[thaiName] || { date: "-", status: "partial" };
            
            mapGroupsList.push({ el: group, name: thaiName, data: info, dateObj: parseThaiDate(info.date) });

            group.addEventListener('mouseenter', () => {
                if(window.innerWidth >= 768) {
                    const li = document.querySelector(`[data-list-prov="${thaiName}"]`);
                    if(li) {
                        const gridWrapper = li.closest('.grid')?.parentElement;
                        if (gridWrapper && gridWrapper.classList.contains('hidden')) {
                             gridWrapper.classList.remove('hidden');
                             const icon = gridWrapper.previousElementSibling.querySelector('.fa-chevron-down');
                             if(icon) icon.classList.add('rotate-180');
                        }
                        listContainer?.scrollTo({ top: li.offsetTop - 120, behavior: 'smooth' });
                        li.classList.add('list-item-highlight');
                        setTimeout(() => li.classList.remove('list-item-highlight'), 1000);
                    }
                }
            });
            
             group.addEventListener('mousemove', (e) => {
                dynamicTooltip.style.opacity = 1;
                dynamicTooltip.innerHTML = `<div class="text-center"><strong>${thaiName}</strong><br><span class="text-xs opacity-80 block mb-1">${info.date !== '-' ? info.date : ''}</span><div class="mt-1 pt-1 border-t border-white/10 text-xs">${statusLabels[info.status]}</div></div>`;
                dynamicTooltip.style.left = e.pageX + 'px';
                dynamicTooltip.style.top = (e.pageY - 10) + 'px';
            });
            group.addEventListener('mouseleave', () => dynamicTooltip.style.opacity = 0);
        });

        function renderList(filterText = "") {
            if (!listContainer) return;
            listContainer.innerHTML = "";
            const groups = { 
                'completed': { title: 'ครบทุกหน่วยราชการ', color: 'text-success', icon: 'fa-check-circle' }, 
                'pending': { title: 'รอการอบรม', color: 'text-pending', icon: 'fa-clock' }, 
                'partial': { title: 'ใช้งานบางพื้นที่', color: 'text-white/60', icon: 'fa-map-pin' } 
            };
            
            const isMobile = window.innerWidth < 768;

            Object.keys(groups).forEach(key => {
                const provinces = Object.entries(provinceData).filter(([name, data]) => data.status === key && name.includes(filterText)).sort((a, b) => parseThaiDate(a[1].date) - parseThaiDate(b[1].date));
                if (provinces.length === 0) return;
                
                const groupContainer = document.createElement('div');
                groupContainer.className = 'mb-2';
                
                const header = document.createElement('h4');
                header.className = `text-sm font-bold uppercase p-3 rounded-lg bg-white/5 flex justify-between items-center ${groups[key].color} cursor-pointer hover:bg-white/10`;
                header.innerHTML = `<div><i class="fa-solid ${groups[key].icon} mr-2"></i>${groups[key].title} (${provinces.length})</div><i class="fa-solid fa-chevron-down transform transition-transform duration-300"></i>`;
                groupContainer.appendChild(header);
                
                const gridWrapper = document.createElement('div');
                let isCollapsed = false;
                if (!filterText && isMobile) isCollapsed = true;
                
                if (isCollapsed) {
                    gridWrapper.classList.add('hidden');
                } else {
                    header.querySelector('.fa-chevron-down').classList.add('rotate-180');
                }
                
                header.addEventListener('click', () => {
                    gridWrapper.classList.toggle('hidden');
                    header.querySelector('.fa-chevron-down').classList.toggle('rotate-180');
                });

                const grid = document.createElement('div');
                grid.className = 'flex flex-wrap gap-2 pt-2';
                
                provinces.forEach(([name, data]) => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center cursor-pointer border border-transparent hover:border-white/10 list-item-sync px-3 py-1.5 rounded-full bg-white/10 text-xs text-white';
                    item.setAttribute('data-list-prov', name);
                    item.innerHTML = `<span class="font-medium">${name}</span>`;
                    
                    item.addEventListener('mouseenter', () => document.querySelector(`#map-container .province[data-province="${name}"]`)?.classList.add('highlight-group'));
                    item.addEventListener('mouseleave', () => document.querySelector(`#map-container .province[data-province="${name}"]`)?.classList.remove('highlight-group'));
                    grid.appendChild(item);
                });
                gridWrapper.appendChild(grid);
                groupContainer.appendChild(gridWrapper);
                listContainer.appendChild(groupContainer);
            });
        }

        function playMapSequence() {
            const timeline = mapGroupsList.filter(d => d.data.status !== 'partial').sort((a, b) => a.dateObj - b.dateObj);
            const orderedDates = timeline.map(d => d.data.date).filter((v, i, a) => a.indexOf(v) === i);
            const dotsByDate = {};
            
            mapGroupsList.forEach(d => {
                d.el.classList.remove('completed', 'pending', 'highlight-group');
                const ds = d.data.date;
                if (!dotsByDate[ds]) dotsByDate[ds] = [];
                dotsByDate[ds].push(d);
            });
            
            let delay = 0;
            orderedDates.forEach(ds => {
                setTimeout(() => {
                    dotsByDate[ds]?.forEach(item => {
                        item.el.classList.add('animating-flip');
                        setTimeout(() => item.el.classList.add(item.data.status), 150);
                        setTimeout(() => item.el.classList.remove('animating-flip'), 300);
                        
                        const li = document.querySelector(`[data-list-prov="${item.name}"]`);
                        if (li && li.offsetParent !== null) { 
                            li.classList.add('list-item-highlight');
                            setTimeout(() => li.classList.remove('list-item-highlight'), 400);
                        }
                    });
                }, delay);
                delay += 100;
            });
        }
        function replayMapAnimation() { playMapSequence(); }

        document.getElementById('province-search')?.addEventListener('input', (e) => renderList(e.target.value.trim()));
    </script>
</body>
</html>